# .github/workflows/build_release.yml

name: Build Executable Release

# This action triggers on any tag push that starts with 'v' (e.g., v1.0, v1.2.3)
on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    # We will run this job on all 3 major OS platforms
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ----- OS-Specific Setup -----

      # On Linux, we must install the system libraries for headless OpenCV
      - name: Install Linux system dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-glx libglib2.0-0

      # ----- Install Python Dependencies -----

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller # Install the executable builder

      # ----- Build the Executable -----

      # Run PyInstaller to create the single-file executable
      # Assumes your script is named 'palette_gen.py'
      - name: Build executable with PyInstaller
        run: pyinstaller --onefile --name=palettegen palette_gen.py

      # ----- Rename and Prepare Artifact -----

      # We rename the executable to include the OS name for clarity
      - name: Prepare artifact for upload
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Windows outputs a .exe file
            mv dist/palettegen.exe dist/palettegen-windows.exe
            echo "ASSET_PATH=dist/palettegen-windows.exe" >> $GITHUB_ENV
            echo "ASSET_NAME=palettegen-windows.exe" >> $GITHUB_ENV
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            # macOS outputs a unix executable
            mv dist/palettegen dist/palettegen-macos
            echo "ASSET_PATH=dist/palettegen-macos" >> $GITHUB_ENV
            echo "ASSET_NAME=palettegen-macos" >> $GITHUB_ENV
          else
            # Linux outputs a unix executable
            mv dist/palettegen dist/palettegen-linux
            echo "ASSET_PATH=dist/palettegen-linux" >> $GITHUB_ENV
            echo "ASSET_NAME=palettegen-linux" >> $GITHUB_ENV
          fi

      # Upload the built executable as an "artifact".
      # This allows the next job to download it.
      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ASSET_NAME }}
          path: ${{ env.ASSET_PATH }}

  # --- This job runs *after* all the build jobs are finished ---
  publish-release:
    runs-on: ubuntu-latest
    needs: build # Wait for the 'build' job to finish
    permissions:
      contents: write # Required to create a release and upload assets

    steps:
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            Automated release of the `palettegen` executable.
            Download the binary for your operating system below.
          draft: false
          prerelease: false

      # Download all the executables that the 'build' jobs uploaded
      - name: Download all executables
        uses: actions/download-artifact@v4
        with:
          path: executables # This directory will contain all artifacts

      # We need to grant execute permissions to the GH CLI
      - name: Make release assets executable
        run: |
          cd executables
          find . -type f -exec chmod +x {} \;
          cd ..

      # Upload all downloaded executables to the new release
      - name: Upload assets to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          # Find all downloaded artifacts and upload them
          # 'gh' is the official GitHub CLI, pre-installed on the runner
          find executables -type f -exec gh release upload ${{ github.ref_name }} {} +

